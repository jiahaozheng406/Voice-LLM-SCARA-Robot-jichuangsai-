<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›¶ä¹±ç»ˆç»“è€… - DeepSeekè¯­éŸ³åŠ©æ‰‹å°å¥•</title>
    <style>



      body {
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(
          circle at top left,
          #0d1b2a,
          #1b263b,
          #0d1b2a
        );
        color: #fff;
        overflow: hidden;
      }
      #chat-container {
        width: 90%;
        max-width: 900px;
        height: 90vh;
        max-height: 700px;
        display: flex;
        flex-direction: column;
        background: rgba(20, 30, 50, 0.95);
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        border: 1px solid rgba(0, 200, 255, 0.3);
      }
      #header {
        background: linear-gradient(90deg, #00c6ff, #0072ff);
        color: white;
        text-align: center;
        padding: 18px;
        font-size: 22px;
        font-weight: bold;
        letter-spacing: 2px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
      }
      #status-indicator {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        font-size: 14px;
      }
      #status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #38ef7d;
        margin-right: 6px;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      #chat-box {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #00c6ff #1b263b;
      }
      #chat-box::-webkit-scrollbar {
        width: 6px;
      }
      #chat-box::-webkit-scrollbar-thumb {
        background: #00c6ff;
        border-radius: 3px;
      }
      #chat-box::-webkit-scrollbar-track {
        background: #1b263b;
      }
      .msg {
        margin: 12px 0;
        padding: 12px 16px;
        border-radius: 10px;
        max-width: 70%;
        line-height: 1.5;
        white-space: pre-wrap;
        animation: fadeIn 0.3s ease-in-out;
      }
      .user {
        background: linear-gradient(135deg, #3a7bd5, #3a6073);
        text-align: right;
        margin-left: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .bot {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        text-align: left;
        margin-right: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .system {
        background: #444;
        color: #fff;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
        max-width: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: none; /* å…³é”®ä¿®æ”¹ï¼šéšè—ç³»ç»Ÿæ¶ˆæ¯ */
      }
      .timestamp {
        font-size: 12px;
        opacity: 0.7;
        margin-bottom: 4px;
      }
      #control-bar {
        padding: 15px;
        text-align: center;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      button {
        padding: 12px 28px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background: linear-gradient(90deg, #00c6ff, #0072ff);
        color: white;
        font-weight: bold;
        letter-spacing: 1px;
        transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
        min-width: 200px;
      }
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 200, 255, 0.5);
      }
      button:disabled {
        background: linear-gradient(90deg, #6c757d, #495057);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      button.recording {
        background: linear-gradient(90deg, #00b42a, #008141);
      }
      button.recording:hover:not(:disabled) {
        box-shadow: 0 4px 15px rgba(0, 180, 42, 0.5);
      }
      #device-info {
        font-size: 12px;
        margin-top: 10px;
        color: rgba(255, 255, 255, 0.7);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .recording-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #38ef7d;
        margin-right: 8px;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
        100% {
          opacity: 1;
        }
      }
      .loading-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @media (max-width: 768px) {
        .msg {
          max-width: 85%;
        }
        #header {
          font-size: 18px;
          padding: 14px;
        }
        button {
          padding: 10px 20px;
          font-size: 14px;
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div id="chat-container">
      <div id="header">
        é›¶ä¹±ç»ˆç»“è€… Â· DeepSeek-Agentæ¡Œé¢æ™ºèƒ½åŠ©æ‰‹å°å¥•
        <div id="status-indicator">
          <span id="status-dot"></span>
          <span>æœåŠ¡åœ¨çº¿</span>
        </div>
      </div>
      <div id="chat-box">
        <h3 style="text-align: center; color: #00c6ff; margin-top: 5px">
          ğŸ¤ å¼€å§‹å’Œå°å¥•å¯¹è¯å§ï¼
        </h3>
        <div id="messages"></div>
      </div>
      <div id="control-bar">
        <button id="record-btn">ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³</button>
        <div id="device-info">éº¦å…‹é£ID: åŠ è½½ä¸­... | æ‰¬å£°å™¨ID: åŠ è½½ä¸­...</div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      const recordBtn = document.getElementById("record-btn");
      const msgBox = document.getElementById("messages");
      const deviceInfo = document.getElementById("device-info");
      const statusDot = document.getElementById("status-dot");
      const statusText = document.querySelector(
        "#status-indicator span:last-child"
      );

      let mediaRecorder;
      let audioContext;
      let sourceNode;
      let stream;
      let audioChunks = [];
      let isRecording = false;
      let isProcessing = false;
      const API_URL = "http://192.168.137.1:8000/stt";
      let deviceData = { mic_id: "æœªçŸ¥", speaker_id: "æœªçŸ¥" };
      const MAX_RECORD_TIME = 10000; // æœ€å¤§å½•éŸ³æ—¶é—´(æ¯«ç§’)
      let recordTimer = null;
      let currentRecordMsg = null; // å½“å‰å½•éŸ³çŠ¶æ€æ¶ˆæ¯

      // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
      function initAudioContext() {
        try {
          window.AudioContext =
            window.AudioContext || window.webkitAudioContext;
          if (!audioContext) {
            audioContext = new AudioContext();
          }
          return true;
        } catch (e) {
          // ä»…åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          console.error("AudioContextåˆå§‹åŒ–å¤±è´¥:", e);
          return false;
        }
      }

      // æ›´æ–°è®¾å¤‡ä¿¡æ¯æ˜¾ç¤º
      function updateDeviceInfo() {
        deviceInfo.textContent = `éº¦å…‹é£ID: ${deviceData.mic_id} | æ‰¬å£°å™¨ID: ${deviceData.speaker_id}`;
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢ - ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—
      function addMessage(sender, text) {
        const now = new Date();
        const timeString = now.toLocaleTimeString();

        const msgDiv = document.createElement("div");
        msgDiv.className = `msg ${sender}`;

        let prefix = "";
        if (sender === "user") prefix = "ğŸ§‘ ä½ è¯´:";
        else if (sender === "bot") prefix = "ğŸ¤– å°å¥•:";
        else if (sender === "system") prefix = "â„¹ï¸ ç³»ç»Ÿ:";

        msgDiv.innerHTML = `<div class="timestamp">${timeString}</div>${prefix}<br>${text}`;
        msgBox.appendChild(msgDiv);
        msgBox.scrollTop = msgBox.scrollHeight;

        return msgDiv;
      }

      // æ’­æ”¾è¯­éŸ³å›å¤
      function playTTS(text) {
        // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
        window.speechSynthesis.cancel();

        // æ£€æŸ¥è¯­éŸ³åˆæˆæ”¯æŒ
        if (!window.speechSynthesis) {
          // ä»…åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          console.error("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œæ— æ³•æ’­æ”¾å›å¤");
          return;
        }

        try {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "zh-CN";
          utterance.rate = 1; // è¯­é€Ÿ
          utterance.pitch = 1; // éŸ³è°ƒ
          utterance.volume = 1; // éŸ³é‡

          // è¯­éŸ³æ’­æ”¾ç»“æŸåæ¢å¤æŒ‰é’®çŠ¶æ€
          utterance.onend = function () {
            if (!isRecording) {
              recordBtn.disabled = false;
              recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
              recordBtn.classList.remove("recording");
            }
          };

          utterance.onerror = function (event) {
            // ä»…åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
            console.error(`è¯­éŸ³æ’­æ”¾å¤±è´¥: ${event.error}`);
            recordBtn.disabled = false;
            recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
            recordBtn.classList.remove("recording");
          };

          // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
          addMessage("system", "æ­£åœ¨æ’­æ”¾å›å¤...");
          speechSynthesis.speak(utterance);
        } catch (e) {
          // ä»…åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          console.error(`è¯­éŸ³åˆæˆé”™è¯¯: ${e.message}`);
          recordBtn.disabled = false;
          recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
          recordBtn.classList.remove("recording");
        }
      }

      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      function checkBrowserSupport() {
        // æ£€æŸ¥åª’ä½“è®¾å¤‡æ”¯æŒ
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          // ä»…åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          console.error(
            "æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³å½•åˆ¶åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆChromeã€Firefoxæˆ–Edgeæµè§ˆå™¨"
          );
          recordBtn.disabled = true;
          return false;
        }

        // æ£€æŸ¥Web Audio APIæ”¯æŒ
        if (!window.AudioContext && !window.webkitAudioContext) {
          // ä»…åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          console.error("æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å¤„ç†åŠŸèƒ½");
          recordBtn.disabled = true;
          return false;
        }

        return true;
      }

      // è½¬æ¢éŸ³é¢‘æ ¼å¼ä¸º16kHzå•å£°é“WAV
      async function convertAudioFormat(audioBlob) {
        // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
        const convertMsg = addMessage("system", "æ­£åœ¨è½¬æ¢éŸ³é¢‘æ ¼å¼...");

        try {
          // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
          if (!initAudioContext()) {
            throw new Error("æ— æ³•åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡");
          }

          // è§£ç éŸ³é¢‘
          const arrayBuffer = await new Response(audioBlob).arrayBuffer();
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

          // åˆ›å»º16kHzçš„ç›®æ ‡é‡‡æ ·ç‡
          const targetSampleRate = 16000;

          // å¦‚æœå½“å‰é‡‡æ ·ç‡å·²ç»æ˜¯16kHzä¸”æ˜¯å•å£°é“ï¼Œç›´æ¥è¿”å›
          if (
            audioBuffer.sampleRate === targetSampleRate &&
            audioBuffer.numberOfChannels === 1
          ) {
            convertMsg.innerHTML = convertMsg.innerHTML.replace(
              "æ­£åœ¨è½¬æ¢",
              "éŸ³é¢‘æ ¼å¼æ— éœ€è½¬æ¢"
            );
            return audioBlob;
          }

          // åˆ›å»ºç¦»çº¿éŸ³é¢‘ä¸Šä¸‹æ–‡è¿›è¡Œé‡é‡‡æ ·
          const offlineContext = new OfflineAudioContext(
            1, // å•å£°é“
            Math.ceil(
              (audioBuffer.length * targetSampleRate) / audioBuffer.sampleRate
            ),
            targetSampleRate
          );

          // åˆ›å»ºæºèŠ‚ç‚¹
          const source = offlineContext.createBufferSource();
          source.buffer = audioBuffer;

          // è¿æ¥åˆ°ç›®çš„åœ°
          source.connect(offlineContext.destination);

          // å¼€å§‹å¤„ç†
          source.start(0);
          const processedBuffer = await offlineContext.startRendering();

          // å°†å¤„ç†åçš„éŸ³é¢‘è½¬æ¢ä¸ºWAVæ ¼å¼
          const wavBlob = audioBufferToWav(processedBuffer);

          convertMsg.innerHTML = convertMsg.innerHTML.replace(
            "æ­£åœ¨è½¬æ¢",
            "éŸ³é¢‘æ ¼å¼è½¬æ¢å®Œæˆ"
          );
          return wavBlob;
        } catch (e) {
          console.error("éŸ³é¢‘è½¬æ¢é”™è¯¯:", e);
          convertMsg.innerHTML = convertMsg.innerHTML.replace(
            "æ­£åœ¨è½¬æ¢",
            `éŸ³é¢‘æ ¼å¼è½¬æ¢å¤±è´¥: ${e.message}`
          );
          throw e;
        }
      }

      // å°†AudioBufferè½¬æ¢ä¸ºWAVæ ¼å¼çš„Blob
      function audioBufferToWav(buffer) {
        const numOfChannels = buffer.numberOfChannels;
        const length = buffer.length * numOfChannels * 2 + 44;
        const bufferArray = new ArrayBuffer(length);
        const view = new DataView(bufferArray);
        const channels = [];

        // å†™å…¥WAVå¤´éƒ¨
        writeString(view, 0, "RIFF");
        view.setUint32(4, length - 8, true);
        writeString(view, 8, "WAVE");
        writeString(view, 12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numOfChannels, true);
        view.setUint32(24, buffer.sampleRate, true);
        view.setUint32(28, buffer.sampleRate * numOfChannels * 2, true);
        view.setUint16(32, numOfChannels * 2, true);
        view.setUint16(34, 16, true);
        writeString(view, 36, "data");
        view.setUint32(40, buffer.length * numOfChannels * 2, true);

        // æ”¶é›†æ‰€æœ‰å£°é“æ•°æ®
        for (let i = 0; i < numOfChannels; i++) {
          channels.push(buffer.getChannelData(i));
        }

        // å†™å…¥éŸ³é¢‘æ•°æ®
        let offset = 44;
        for (let i = 0; i < buffer.length; i++) {
          for (let j = 0; j < numOfChannels; j++) {
            const sample = Math.max(-1, Math.min(1, channels[j][i]));
            view.setInt16(
              offset,
              sample < 0 ? sample * 0x8000 : sample * 0x7fff,
              true
            );
            offset += 2;
          }
        }

        return new Blob([bufferArray], { type: "audio/wav" });
      }

      // è¾…åŠ©å‡½æ•°ï¼šå†™å…¥å­—ç¬¦ä¸²åˆ°DataView
      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      // åœæ­¢å½•éŸ³
      function stopRecording() {
        if (isRecording && mediaRecorder) {
          // æ¸…é™¤å½•éŸ³è®¡æ—¶å™¨
          if (recordTimer) {
            clearTimeout(recordTimer);
            recordTimer = null;
          }

          isRecording = false;
          mediaRecorder.stop();

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          recordBtn.innerHTML =
            '<span class="loading-indicator"></span>å¤„ç†ä¸­...';
          recordBtn.classList.remove("recording");

          // æ›´æ–°å½•éŸ³çŠ¶æ€æ¶ˆæ¯ï¼ˆä¼šè¢«CSSéšè—ï¼‰
          if (currentRecordMsg) {
            currentRecordMsg.innerHTML = currentRecordMsg.innerHTML.replace(
              "æ­£åœ¨å½•éŸ³",
              "å½•éŸ³å·²åœæ­¢ï¼Œå¤„ç†ä¸­..."
            );
          }

          // åœæ­¢æ‰€æœ‰éŸ³è½¨
          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
            stream = null;
          }

          // å…³é—­éŸ³é¢‘èŠ‚ç‚¹
          if (sourceNode) {
            sourceNode.disconnect();
            sourceNode = null;
          }
        }
      }

      // å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨å¤„ç†
      async function processAudio(audioBlob) {
        if (isProcessing) return;
        isProcessing = true;

        try {
          // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
          addMessage("system", "æ­£åœ¨å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨å¤„ç†...");

          const reader = new FileReader();
          reader.onload = async () => {
            try {
              // å‘é€è¯·æ±‚
              const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ audio: reader.result }),
                timeout: 30000, // 30ç§’è¶…æ—¶
              });

              // æ£€æŸ¥HTTPçŠ¶æ€
              if (!response.ok) {
                let errorMsg = `æœåŠ¡å™¨é”™è¯¯: HTTP ${response.status}`;
                try {
                  const errorData = await response.json();
                  errorMsg += ` - ${
                    errorData.message || errorData.details || "æœªçŸ¥é”™è¯¯"
                  }`;
                } catch (e) {
                  // å°è¯•è·å–æ–‡æœ¬é”™è¯¯ä¿¡æ¯
                  const text = await response.text();
                  errorMsg += ` - ${text.substring(0, 100)}`;
                }
                throw new Error(errorMsg);
              }

              // è§£æå“åº”
              const contentType = response.headers.get("content-type");
              if (!contentType || !contentType.includes("application/json")) {
                const text = await response.text();
                throw new Error(
                  `æœåŠ¡å™¨è¿”å›éJSONæ•°æ®: ${text.substring(0, 100)}`
                );
              }

              const data = await response.json();

              // æ›´æ–°è®¾å¤‡ä¿¡æ¯
              if (data.device_info) {
                deviceData = data.device_info;
                updateDeviceInfo();
              }

              // æ˜¾ç¤ºç»“æœ
              if (data.status === "success") {
                addMessage("user", data.user_text);
                const botMsg = addMessage("bot", data.reply);

                // è‡ªåŠ¨æ’­æ”¾å›å¤
                playTTS(data.reply);
              } else {
                throw new Error(data.message || "å¤„ç†å¤±è´¥ï¼Œæœªè¿”å›å…·ä½“åŸå› ");
              }
            } catch (err) {
              console.error("è¯·æ±‚å¤„ç†é”™è¯¯:", err);
              // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
              addMessage("system", `æœåŠ¡é”™è¯¯: ${err.message}`);
            } finally {
              isProcessing = false;
              recordBtn.disabled = false;
              recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
            }
          };

          reader.onerror = function () {
            // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
            addMessage("system", `æ–‡ä»¶è¯»å–é”™è¯¯: ${reader.error.message}`);
            isProcessing = false;
            recordBtn.disabled = false;
            recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
          };

          reader.readAsDataURL(audioBlob);
        } catch (err) {
          console.error("å¤„ç†éŸ³é¢‘å¤±è´¥:", err);
          // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
          addMessage("system", `å¤„ç†éŸ³é¢‘å¤±è´¥: ${err.message}`);
          isProcessing = false;
          recordBtn.disabled = false;
          recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
        }
      }

      // å½•éŸ³æŒ‰é’®äº‹ä»¶
      recordBtn.addEventListener("click", async () => {
        if (isProcessing) return;

        if (!checkBrowserSupport()) return;

        try {
          if (isRecording) {
            // åœæ­¢å½•éŸ³
            stopRecording();
            return;
          }

          // å¼€å§‹å½•éŸ³
          recordBtn.disabled = true;

          // è¯·æ±‚éº¦å…‹é£æƒé™
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 16000, // ä¼˜å…ˆè¯·æ±‚16kHz
              },
            });
          } catch (err) {
            // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
            addMessage("system", "å°è¯•ä½¿ç”¨é»˜è®¤éŸ³é¢‘é…ç½®...");
            stream = await navigator.mediaDevices.getUserMedia({
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
              },
            });
          }

          // åˆå§‹åŒ–å½•éŸ³
          audioChunks = [];
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (e) => {
            audioChunks.push(e.data);
          };

          mediaRecorder.onstop = async () => {
            try {
              const audioBlob = new Blob(audioChunks, { type: "audio/wav" });

              // æ£€æŸ¥éŸ³é¢‘é•¿åº¦
              if (audioBlob.size < 1024) {
                throw new Error("å½•éŸ³æ•°æ®è¿‡çŸ­ï¼Œè¯·é‡æ–°å°è¯•");
              }

              // è½¬æ¢éŸ³é¢‘æ ¼å¼
              const formattedBlob = await convertAudioFormat(audioBlob);

              // å¤„ç†éŸ³é¢‘
              await processAudio(formattedBlob);
            } catch (err) {
              console.error("å½•éŸ³å¤„ç†é”™è¯¯:", err);
              // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
              addMessage("system", `å½•éŸ³å¤„ç†é”™è¯¯: ${err.message}`);
              recordBtn.disabled = false;
              recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
            }
          };

          mediaRecorder.onerror = function (err) {
            console.error("å½•éŸ³é”™è¯¯:", err);
            // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
            addMessage("system", `å½•éŸ³å¤±è´¥: ${err.message}`);
            stopRecording();
            recordBtn.disabled = false;
            recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
          };

          // å¼€å§‹å½•éŸ³
          mediaRecorder.start();
          isRecording = true;
          recordBtn.disabled = false;
          recordBtn.innerHTML =
            '<span class="recording-indicator"></span>â¹ åœæ­¢å½•éŸ³';
          recordBtn.classList.add("recording");
          // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
          currentRecordMsg = addMessage("system", "æ­£åœ¨å½•éŸ³...ï¼ˆæœ€é•¿10ç§’ï¼‰");

          // è®¾ç½®æœ€å¤§å½•éŸ³æ—¶é—´
          recordTimer = setTimeout(() => {
            if (isRecording) {
              currentRecordMsg.innerHTML = currentRecordMsg.innerHTML.replace(
                "æ­£åœ¨å½•éŸ³",
                "å·²è¾¾åˆ°æœ€é•¿å½•éŸ³æ—¶é—´ï¼Œè‡ªåŠ¨åœæ­¢"
              );
              stopRecording();
            }
          }, MAX_RECORD_TIME);
        } catch (err) {
          console.error("å½•éŸ³å¯åŠ¨é”™è¯¯:", err);
          // ç³»ç»Ÿæ¶ˆæ¯ä¼šè¢«CSSéšè—ï¼Œä¸å½±å“ç•Œé¢
          addMessage(
            "system",
            `éº¦å…‹é£è®¿é—®å¤±è´¥: ${err.message || "è¯·æ£€æŸ¥éº¦å…‹é£æƒé™"}`
          );
          isRecording = false;
          recordBtn.disabled = false;
          recordBtn.innerHTML = "ğŸ™ ç‚¹å‡»å¼€å§‹å½•éŸ³";
          recordBtn.classList.remove("recording");

          // æ¸…ç†æµ
          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
            stream = null;
          }
        }
      });

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.onload = function () {
        checkBrowserSupport();
        updateDeviceInfo();
      };

      // çª—å£å…³é—­æ—¶æ¸…ç†
      window.onbeforeunload = function () {
        if (isRecording) {
          stopRecording();
        }

        if (audioContext) {
          audioContext.close();
        }
      };
    </script>
  </body>
</html>
